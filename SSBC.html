
<!DOCTYPE html>
<html>
  <head>
    <title>Dr. J - SSBC</title>
    <script type="text/javascript">
                var running = true;
                var cmds = [
                   ["no-op", 0],
                   ["halt", 0],
                   ["pushimm", 1],
                   ["push ext", 2],
                   ["pop", 0],
                   ["pop ext", 2],
                   ["jnz", 2],
                   ["add", 0],
                   ["sub", 0],
                   ["nor", 0],
                   ["jnn", 2]
                ];

		var reader = new FileReader();

function ScrollToElement(theElement){

  var selectedPosX = 0;
  var selectedPosY = 0;

  while(theElement != null){
    //selectedPosX += theElement.offsetLeft;
    selectedPosY += theElement.offsetTop;
    theElement = theElement.offsetParent;
  }

 window.scrollTo(selectedPosX,selectedPosY);

}
                function execute(cmd) {
                   var pc = parseInt(document.getElementById('pc').value);
                   var imm = parseInt(cellAt(pc+1).innerHTML, 2);
                   var addr = imm*256 + parseInt(cellAt(pc+2).innerHTML, 2);
                   var top = document.getElementById('mystack').rows[parseInt(document.getElementById('sp').value)].cells[0];
                   document.getElementById('mystack').rows[parseInt(document.getElementById('sp').value)].cells[0].style.backgroundColor = "white";
                   if(cmd <0 || cmd > 10) //push ext
                   {
                      running = false;
                      alert("Fault Line " + pc);
                   }
                   if(cmd == 0) //no-op
                   {

                   }
                   if(cmd == 1) //halt
                   {
                      running = false;
                      alert("Halt Line " + pc);
                   }

                   if(cmd == 2) //push imm
                   {
                      top.innerHTML = imm.toString(2).substr(0,8);
                      document.getElementById('sp').value = parseInt(document.getElementById('sp').value) + 1;
                   }

                   if(cmd == 3) //push ext
                   {
                      top.innerHTML = cellAt(addr).innerHTML.substr(0,8);
                      document.getElementById('sp').value = parseInt(document.getElementById('sp').value) + 1;
                      cellAt(addr).style.backgroundColor = "orange";
                   }

                   if(cmd == 4) //pop
                   {
                      document.getElementById('sp').value = parseInt(document.getElementById('sp').value) - 1;
                      if(parseInt(document.getElementById('sp').value) < 0)
                      {
                         running = false;
                         alert("Pop of empty stack " + cp);
                      }

                   }

                   if(cmd == 5) //pop ext
                   {
                      document.getElementById('sp').value = parseInt(document.getElementById('sp').value) - 1;
                      if(parseInt(document.getElementById('sp').value) < 0)
                      {
                         running = false;
                         alert("Pop of empty stack " + cp);
                      }

                      top = document.getElementById('mystack').rows[parseInt(document.getElementById('sp').value)].cells[0];
                      cellAt(addr).innerHTML = top.innerHTML;
                      cellAt(addr).style.backgroundColor = "cyan";
                   }

                   if(cmd == 7 || cmd == 8 || cmd == 9) //add, sub, nor
                   {
                      document.getElementById('sp').value = parseInt(document.getElementById('sp').value) - 1;
                      if(parseInt(document.getElementById('sp').value) < 1)
                      {
                         running = false;
                         alert("Pop of empty stack " + cp);
                      }

                      var v1 = parseInt(document.getElementById('mystack').rows[parseInt(document.getElementById('sp').value)].cells[0].innerHTML, 2);
                      var v2 = parseInt(document.getElementById('mystack').rows[parseInt(document.getElementById('sp').value)-1].cells[0].innerHTML, 2);
                      var result;
                      if(cmd == 7)
                         result = v1 + v2;
                      if(cmd == 8)
                         result = v1 - v2;
                      if(cmd == 9)
                         result = ~(v1 | v2);
                     

                      if(result == 0)
                         cellAt(65531).innerHTML = "10000000"; //PSW
                      if(result > 0)
                         cellAt(65531).innerHTML = "00000000"; //PSW
                      if(result < 0)
                         cellAt(65531).innerHTML = "01000000"; //PSW

                      document.getElementById('mystack').rows[parseInt(document.getElementById('sp').value)-1].cells[0].innerHTML = result.toString(2);

                   }

                   if((cmd == 6  && parseInt(cellAt(65531).innerHTML, 2) != parseInt("10000000", 2))
                    ||(cmd == 10 && parseInt(cellAt(65531).innerHTML, 2) != parseInt("01000000", 2))) //jnn jnz
                   {
                      cellAt(pc).style.backgroundColor = "pink";
                      document.getElementById('pc').value = addr-3;
                      pc = parseInt(document.getElementById('pc').value);
                      //cellAt(pc).style.backgroundColor = "violet";

                   }


                   document.getElementById('mystack').rows[parseInt(document.getElementById('sp').value)].cells[0].style.backgroundColor = "green";

                }

                function cellAt(loc) {
                   var myTable;
                   var col = 1;
                   var row = loc;

                   if(loc<256)
                   {
                      while(row>=64)
                      {
                         row -= 64;
                         col += 1;
                      }

                       myTable = document.getElementById('dataSection');
                       return myTable.rows[row].cells[col];
                   }
                   else
                   {
                       col = (loc %8)-3
                       myTable = document.getElementById('dataPorts');
                       return myTable.rows[1].cells[col];
                   }
                }


                function run() {
                   running = true;
                   runMore();
                }

                function runMore() {
                   if(!running)
                   {
                       return;
                   }
                   setTimeout(runMore, 100);
                   step();                       
                }

                function stop() {
                   running = false;               
                }

                function step() {
                   var pc = parseInt(document.getElementById('pc').value);

                   var myTable = document.getElementById('dataSection');

                   document.getElementById('ir').value = cellAt(pc).innerHTML.substr(0,8);
                   var cmd = parseInt(document.getElementById('ir').value, 2);

                   cellAt(pc).style.backgroundColor = "white";
                   pc++;
                   if(cmd < 11)
                      document.getElementById('irc').value = cmds[cmd][0];
                   execute(cmd);
                   pc = parseInt(document.getElementById('pc').value);
                   if(cmd < 11)
                      pc += cmds[cmd][1];
                   pc += 1;

                   col = 1;
                   cellAt(pc).style.backgroundColor = "yellow";
ScrollToElement(cellAt(pc));
                   document.getElementById('pc').value = pc;

                }

		function readText(that){ 

			if(that.files && that.files[0]){
				var reader = new FileReader();
				reader.onload = function (e) {  
					var output=e.target.result;
				
					//process text to show only lines with "@":				
					//output=output.split("\n").filter(/./.test, /\@/).join("\n");
                                        var col = 1;
                                        var row = 0;
                                        var myTable = document.getElementById('dataSection');
                                        var lines = this.result.split('\n');
                                        for(var line = 0; line < lines.length; line++){
                                            myTable.rows[row].cells[col].innerHTML = lines[line].substr(0,20);
                                            row++;
                                            if (row == 64)
                                            {
                                               row = 0;
                                               col++;
                                            }
                                        }
                                        myTable.rows[0].cells[1].style.backgroundColor = "yellow";
				};//end onload()
				reader.readAsText(that.files[0]);
                                document.getElementById('pc').value = "0000";
                                document.getElementById('ir').value = "00000000";
                                document.getElementById('irc').value = "";
                                document.getElementById('sp').value = "0000";
                                document.getElementById('mystack').rows[parseInt(document.getElementById('sp').value)].cells[0].style.backgroundColor = "green";
                                running = true;

			}//end if html5 filelist support
		} 
</script>

<style>
table.absolu {
    position: fixed;
    left: 0px;
    top: 50px;
}
</style>

</head>
<body>
	<input type="file" onchange='readText(this)' />
	<div id="main"></div>
<table border="1" style="width:180px" class = "absolu"><tr><td>
    <table border="1" style="width:100%">
      <tr><td><button onclick="step()">Step</button></td>
      <td><button onclick="run()">Run</button><button onclick="stop()">Stop</button></td></tr>

      <tr><td><button onclick="document.getElementById('dataPorts').rows[1].cells[2].innerHTML = document.getElementById('portB').value">Set B</button></td><td> <input type="text" size="10" maxlength="8" id="portB" value="00000000"></td></tr>
      <tr><td><button onclick="document.getElementById('dataPorts').rows[1].cells[4].innerHTML = document.getElementById('portD').value">Set D</button></td><td> <input type="text" size="10" maxlength="8" id="portD" value="00000000"></td></tr>

      <tr><td>PC:</td><td> <input type="text" size="10" id="pc" value="0000" readonly></td></tr>
      <tr><td>IR:</td><td> <input type="text" size="10" id="ir" value="00000000" readonly></td></tr>
      <tr><td>IR:</td><td> <input type="text" size="10" id="irc" value="" readonly></td></tr>
      <tr><td>SP:</td><td> <input type="text" size="10" id="sp" value="0000" readonly></td></tr>
    </table> 

    <table border="1" id="mystack" style="width:100%">
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>
       <tr><td>0000</td></tr>


    </table>
</td></tr></table>  

<table border="0" style="width:100%">
  <tr>
    <td style="width:200px"></td>
    <td style="width:*">
    <table id="dataPorts" border="1" style="width:100%">
      <tr><td>PSW</td><td>A</td><td>B</td><td>C</td><td>D</td> </tr>
      <tr><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
    </table>
<BR>
    <table id="dataSection" border="1" style="width:100%">
      <tr><td>0000</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0001</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0002</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0003</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0004</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0005</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0006</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0007</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0008</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0009</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>000A</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>000B</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>000C</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>000D</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>000E</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>000F</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>

      <tr><td>0010</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0011</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0012</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0013</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0014</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0015</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0016</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0017</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0018</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0019</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>001A</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>001B</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>001C</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>001D</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>001E</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>001F</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>

      <tr><td>0020</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0021</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0022</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0023</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0024</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0025</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0026</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0027</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0028</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0029</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>002A</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>002B</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>002C</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>002D</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>002E</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>002F</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>

      <tr><td>0030</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0031</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0032</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0033</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0034</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0035</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0036</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0037</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0038</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>0039</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>003A</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>003B</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>003C</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>003D</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>003E</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>
      <tr><td>003F</td><td>00000000</td><td>00000000</td><td>00000000</td><td>00000000</td> </tr>

    </table> 
  </td>
</tr>
</table> 

  </body>
</html>

